---
title: "Lab 07: Violence and Life Expectancy"
subtitle: "Lecture Note"
author: "Chiaki"
date: "2025-10-13"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
  pdf_document:
    toc: true
    number_sections: true
fontsize: 11pt
---

**clean environment**

```{r, eval=TRUE, message=TRUE, warning=TRUE}
rm(list=ls())
```

**Install Packages**

- various qualitative color palettes  
- various themes in ggplot  
- linear regression in tidyverse  
- tables  
- plot coefficients

```{r}
#install.packages('ggthemes') 
#install.packages('RColorBrewer') 
#install.packages('moderndive') 
#install.packages('ggstats')
library('RColorBrewer') 
library('ggthemes') 
library("tidyverse")  
library("moderndive")
library('knitr')
library('ggstats')
```

## Upload data

- Violence data  
- Data on male life expectancy  
- Data on female life expectancy

```{r}
# Violence data
gpi_data <- read.csv('Data/data_gpi_final.csv') 
# Data on male life expectancy
life_exp_male <- read.csv('Data/male_data.csv')
# Data on female life expectancy
life_exp_female <- read.csv('Data/female_data.csv')
```

ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼: ctrl + shift + c

# Combine data sets

1. GPIã‚’åŸºæº–ã«ã—ã¦å§‹ã‚ã‚‹  
2. ç”·æ€§å¯¿å‘½ãƒ‡ãƒ¼ã‚¿ (life_exp_male) ã‚’ã€iso3ï¼ˆå›½ã‚³ãƒ¼ãƒ‰ï¼‰ã¨ Yearï¼ˆå¹´ï¼‰ã¨ã„ã†å…±é€šã‚«ãƒ©ãƒ ã‚’ä½¿ã£ã¦çµåˆã™ã‚‹  
3. æ¬¡ã«ã€ãã®çµæœã« å¥³æ€§å¯¿å‘½ãƒ‡ãƒ¼ã‚¿ (life_exp_female) ã‚’ã€iso3, Year, country ã®3ã¤ã®å…±é€šã‚«ãƒ©ãƒ ã§çµåˆã™ã‚‹  
æœ€çµ‚çš„ã«ã€ã™ã¹ã¦ã®æƒ…å ±ãŒãã‚ã£ãŸæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ data ã«ä¿å­˜ã™ã‚‹

```{r}
data <- gpi_data |>
  inner_join(life_exp_male,by=c("iso3","Year")) |>
  inner_join(life_exp_female,by=c("iso3","Year","country")) 
```

# Question 1

## data to be plotted

Step 1: çµåˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ "data" ã‚’ã‚‚ã¨ã«å‡¦ç†ã‚’é–‹å§‹  
Step 2: "Year"ï¼ˆå¹´ï¼‰ã¨ "area"ï¼ˆåœ°åŸŸï¼‰ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ï¼ˆå„å¹´ãƒ»å„åœ°åŸŸå˜ä½ã§é›†è¨ˆï¼‰  
Step 3: summarize() ã§äººå£åŠ é‡å¹³å‡ï¼ˆweighted meanï¼‰ã‚’è¨ˆç®—ã™ã‚‹  
- gpi = æš´åŠ›ãƒ¬ãƒ™ãƒ«ï¼ˆGlobal Peace Indexï¼‰  
- pop = å„å›½ã®äººå£ï¼ˆé‡ã¿ã¨ã—ã¦ä½¿ç”¨ï¼‰  
- weighted.mean() = äººå£ã‚’é‡ã¿ã¨ã—ã¦å¹³å‡  
- na.rm = FALSE ã¯æ¬ æå€¤ã‚’ç„¡è¦–ã—ãªã„è¨­å®šï¼ˆTRUEã«ã™ã‚‹ã¨ç„¡è¦–ï¼‰

```{r}
data_violence_region <- data |>
  group_by(Year,area) |>
  summarize(gpi=weighted.mean(x=gpi,w=pop,na.rm = FALSE)) 
```

## plot

åœ°åŸŸã”ã¨ã®æš´åŠ›ãƒ¬ãƒ™ãƒ«ï¼ˆGPIï¼‰ã®æ¨ç§»ã‚’å¯è¦–åŒ–ã™ã‚‹ãƒ—ãƒ­ãƒƒãƒˆã‚’ä½œæˆã€‚  
- ggplot() ã§æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•  
- "data_violence_region" ã¯åœ°åŸŸåˆ¥ã®å¹´æ¬¡GPIå¹³å‡

```{r}
plot1 <- ggplot(
  data = data_violence_region,                 # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
  mapping = aes(x = Year, y = gpi, color = area) # Xè»¸=å¹´, Yè»¸=GPI, è‰²=åœ°åŸŸ
) +
  geom_line() +        # å„åœ°åŸŸã®GPIã®æ¨ç§»ã‚’ç·šã§æã
  geom_point() +       # å„å¹´ã”ã¨ã«ç‚¹ã‚’è¿½åŠ ã—ã¦è¦–èªæ€§ã‚’ä¸Šã’ã‚‹
  theme_clean() +      # èƒŒæ™¯ã‚’ã‚·ãƒ³ãƒ—ãƒ«ãªç™½åŸºèª¿ã«å¤‰æ›´
  scale_color_brewer(
    name = "Region",   # å‡¡ä¾‹ã‚¿ã‚¤ãƒˆãƒ«
    palette = "Set3"   # RColorBrewerã®ã€ŒSet3ã€ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ (https://r-graph-gallery.com/38-rcolorbrewers-palettes.html)
  ) +
  scale_x_continuous(
    breaks = seq(2009, 2023, 2),  # Xè»¸ã®ç›®ç››ã‚Šï¼ˆ2009å¹´ã‹ã‚‰2å¹´åˆ»ã¿ï¼‰
    labels = seq(2009, 2023, 2)   # è¡¨ç¤ºãƒ©ãƒ™ãƒ«ã‚‚åŒã˜ç¯„å›²ã§æŒ‡å®š
  ) +
  xlab('Year') +                  # Xè»¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€ŒYearã€ã«è¨­å®š
  ylab('Level of Violence') +     # Yè»¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€ŒLevel of Violenceã€ã«è¨­å®š
  ggtitle('Region-specific Violence over Time')  # ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«

# æœ€å¾Œã«ãƒ—ãƒ­ãƒƒãƒˆã‚’å‡ºåŠ›
plot1
```

å‡ºåŠ›çµæœ: å„åœ°åŸŸã”ã¨ã®æš´åŠ›ãƒ¬ãƒ™ãƒ«ï¼ˆGPIï¼‰ã®å¹³å‡å€¤ã‚’ã€2009å¹´ã€œ2023å¹´ã®æœŸé–“ã§æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã¨ã—ã¦è¡¨ç¤ºã€‚  
ç·šã®è‰²ã§åœ°åŸŸã‚’åŒºåˆ¥ã—ã€æš´åŠ›ãƒ¬ãƒ™ãƒ«ã®æ™‚é–“çš„ãªå¤‰åŒ–ã‚’æ¯”è¼ƒã§ãã‚‹ã€‚

# Question 2

## åœ°åŸŸã”ã¨ã®ç”·å¥³åˆ¥å¹³å‡å¯¿å‘½ã®æ¨ç§»ã‚’ä½œæˆãƒ»å¯è¦–åŒ–

â–¼ Step 1: ãƒ‡ãƒ¼ã‚¿æ•´å½¢  
"data" ã¯ç”·æ€§ãƒ»å¥³æ€§ã®å¯¿å‘½ãŒåˆ¥ã€…ã®åˆ—ï¼ˆwideï¼‰ã€‚pivot_longer() ã§ long ã«ã€‚  
æ€§åˆ¥ã‚’ "sex" åˆ—ã€å¯¿å‘½ã‚’ "life_exp" åˆ—ã«ã€‚

```{r}
data_life_exp_region <- data |>
  pivot_longer(
    !c('Year','iso3','pop','area','gpi','country'),  # é™¤å¤–ã™ã‚‹åˆ—ï¼ˆãã‚Œä»¥å¤–ã®åˆ—ã‚’å¤‰æ›å¯¾è±¡ã«ã™ã‚‹ï¼‰
    names_to = 'sex',       # å…ƒã®åˆ—åã‚’ 'sex' ã¨ã„ã†æ–°ã—ã„åˆ—ã«æ ¼ç´
    values_to = 'life_exp'  # å¯¾å¿œã™ã‚‹å€¤ã‚’ 'life_exp' åˆ—ã«æ ¼ç´
  ) |>
  
  # â–¼ Step 2: æ€§åˆ¥å¤‰æ•°ã‚’æ•´å½¢
  # ã‚‚ã¨ã®åˆ—åï¼ˆä¾‹ï¼š"life_exp_male", "life_exp_female"ï¼‰ã®10æ–‡å­—ç›®ä»¥é™ã‚’æŠ½å‡ºã—ã¦
  # "male" ã¨ "female" ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ©ãƒ™ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
  mutate(sex = substr(sex, 10, length(sex))) |>
  
  # â–¼ Step 3: åœ°åŸŸãƒ»å¹´ãƒ»æ€§åˆ¥ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦åŠ é‡å¹³å‡ã‚’è¨ˆç®—
  group_by(Year, area, sex) |>
  summarize(
    life_exp = weighted.mean(x = life_exp, w = pop, na.rm = FALSE)  # äººå£åŠ é‡å¹³å‡, na.rm = æ¬ æå€¤ï¼ˆNAï¼‰ã‚’å‰Šé™¤ã›ãšã«è¨ˆç®—ã™ã‚‹è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦TRUEã«å¤‰æ›´å¯èƒ½ï¼‰
  )
```

çµæœ: å„åœ°åŸŸãƒ»å„å¹´ãƒ»æ€§åˆ¥ã”ã¨ã®å¹³å‡å¯¿å‘½ãƒ‡ãƒ¼ã‚¿ãŒæ•´ã†ã€‚ã“ã‚Œã‚’å…ƒã«ã‚°ãƒ©ãƒ•ã‚’ä½œæˆã€‚

â–¼ Step 4: ç”·å¥³åˆ¥ãƒ»åœ°åŸŸåˆ¥ã®å¹³å‡å¯¿å‘½ã®æ¨ç§»ã‚’å¯è¦–åŒ–

```{r}
plot2 <- ggplot(
  data = data_life_exp_region,                     # ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
  mapping = aes(x = Year, y = life_exp, color = area)  # Xè»¸=å¹´, Yè»¸=å¹³å‡å¯¿å‘½, è‰²=åœ°åŸŸ
) +
  geom_line() +      # åœ°åŸŸã”ã¨ã®å¯¿å‘½æ¨ç§»ã‚’ç·šã§è¡¨ç¤º
  geom_point() +     # å„å¹´ã®ãƒ‡ãƒ¼ã‚¿ç‚¹ã‚’è¿½åŠ 
  annotate("text", x = 2020, y = 55, label = "COVID-19") +  # COVID-19ã®å½±éŸ¿ã‚’ç¤ºã™æ³¨é‡ˆã‚’è¿½åŠ 
  theme_clean() +    # èƒŒæ™¯ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«
  facet_wrap(~sex) + # æ€§åˆ¥ã”ã¨ã«2ã¤ã®ã‚°ãƒ©ãƒ•ã‚’ä½œæˆï¼ˆç”·å¥³æ¯”è¼ƒãŒã§ãã‚‹ï¼‰
  xlab('Year') +     # Xè»¸ãƒ©ãƒ™ãƒ«
  ylab('Life Expectancy at Age 30') +  # Yè»¸ãƒ©ãƒ™ãƒ«
  scale_color_brewer(name = "Region", palette = "Set1") +  # ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè¨­å®š
  ggtitle('Region-specific Life Expectancy over Time')     # ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«

# ãƒ—ãƒ­ãƒƒãƒˆã‚’å‡ºåŠ›
plot2
```

å‡ºåŠ›çµæœ:  
- Xè»¸ = å¹´ï¼ˆ2009ã€œ2023ï¼‰  
- Yè»¸ = 30æ­³æ™‚ç‚¹ã®å¹³å‡ä½™å‘½ï¼ˆLife Expectancy at Age 30ï¼‰  
- è‰² = åœ°åŸŸï¼ˆareaï¼‰  
- 2ã¤ã®ãƒ•ã‚¡ã‚»ãƒƒãƒˆã§ç”·å¥³æ¯”è¼ƒ  
- COVID-19 ã®æ³¨é‡ˆã‚ã‚Š

# Question 3

--- æš´åŠ›ãƒ¬ãƒ™ãƒ«ï¼ˆGPIï¼‰ã¨å¹³å‡å¯¿å‘½ã®é–¢ä¿‚ã‚’2023å¹´ãƒ‡ãƒ¼ã‚¿ã§å¯è¦–åŒ–ã™ã‚‹æº–å‚™ã¨ãƒ—ãƒ­ãƒƒãƒˆ ---

â–¼ Step 1: ãƒ‡ãƒ¼ã‚¿æ•´å½¢  
"data" ã® wide ã‚’ pivot_longer() ã§ long ã«ã€‚sex åˆ—ã¨ life_exp åˆ—ã‚’ä½œã‚‹ã€‚

```{r}
data_scatter <- data |>
  pivot_longer(
    !c('Year','iso3','pop','area','gpi','country'), # é™¤å¤–ã™ã‚‹åˆ—ã‚’æŒ‡å®š
    names_to = 'sex',        # å…ƒã®åˆ—åï¼ˆä¾‹: life_exp_maleï¼‰ã‚’ sex ã«æ ¼ç´
    values_to = 'life_exp'   # å„åˆ—ã®å€¤ã‚’ life_exp ã«æ ¼ç´
  ) |>
  
  # â–¼ Step 2: æ€§åˆ¥æƒ…å ±ã®æ•´ç†
  # åˆ—åï¼ˆ"life_exp_male" ã‚„ "life_exp_female"ï¼‰ã®10æ–‡å­—ç›®ä»¥é™ã‚’å–ã‚Šå‡ºã—ã¦
  # "male" ã¨ "female" ã ã‘ã‚’æ®‹ã™ã€‚
  mutate(sex = substr(sex, 10, length(sex))) |>
  
  # â–¼ Step 3: 2023å¹´ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’æŠ½å‡º
  filter(Year == 2023)
```

çµæœ: 2023å¹´ã® gpi ã¨ life_exp ãŒãã‚ã†ã€‚

â–¼ Step 4: æš´åŠ›ãƒ¬ãƒ™ãƒ«ã¨å¯¿å‘½ã®é–¢ä¿‚ã‚’ãƒ—ãƒ­ãƒƒãƒˆ

```{r}
plot3 <- ggplot(
  data = data_scatter,                       # ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
  mapping = aes(x = gpi, y = life_exp)       # Xè»¸ = æš´åŠ›ãƒ¬ãƒ™ãƒ«, Yè»¸ = å¹³å‡å¯¿å‘½
) +
  geom_point(size = 2) +                     # å„å›½ã‚’ç‚¹ã§è¡¨ç¤ºï¼ˆç‚¹ã®å¤§ãã•=2ï¼‰
  xlab('Level of Violence') +                # Xè»¸ãƒ©ãƒ™ãƒ«
  ylab('Life Expectancy at Age 30') +        # Yè»¸ãƒ©ãƒ™ãƒ«
  theme_economist() +                        # çµŒæ¸ˆèªŒé¢¨ã®ãƒ†ãƒ¼ãƒã‚’ä½¿ç”¨ï¼ˆèƒŒæ™¯ã‚’ã‚°ãƒ¬ãƒ¼ã«ï¼‰
  
  # â–¼ Step 5: å›å¸°ç›´ç·šã‚’è¿½åŠ 
  # method = "lm" ã¯ç·šå½¢å›å¸°, se = FALSE ã¯ä¿¡é ¼åŒºé–“éè¡¨ç¤º, color = 'red'
  geom_smooth(method = "lm", se = FALSE, color = 'red') +
  
  # â–¼ Step 6: æ€§åˆ¥ã”ã¨ã«ãƒ—ãƒ­ãƒƒãƒˆã‚’åˆ†ã‘ã‚‹
  facet_wrap(~sex) +                         # ç”·æ€§ãƒ»å¥³æ€§ã§ã‚µãƒ–ãƒ—ãƒ­ãƒƒãƒˆ
  
  # â–¼ Step 7: è»¸ã¨ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºãƒ»å¤ªå­—è¨­å®š
  theme(
    axis.text.y   = element_text(size = 15, face = "bold"),   # Yè»¸ç›®ç››ã‚Š
    axis.title.y  = element_text(size = 15, face = "bold"),   # Yè»¸ã‚¿ã‚¤ãƒˆãƒ«
    axis.text.x   = element_text(size = 15, face = "bold"),   # Xè»¸ç›®ç››ã‚Š
    axis.title.x  = element_text(size = 15, face = "bold")    # Xè»¸ã‚¿ã‚¤ãƒˆãƒ«
  )

# ãƒ—ãƒ­ãƒƒãƒˆã‚’å‡ºåŠ›
plot3
```

å‡ºåŠ›çµæœ:  
- Xè»¸ = æš´åŠ›ãƒ¬ãƒ™ãƒ«ï¼ˆGPIå€¤ãŒé«˜ã„ã»ã©æš´åŠ›çš„ï¼‰  
- Yè»¸ = å¹³å‡å¯¿å‘½ï¼ˆ30æ­³æ™‚ç‚¹ï¼‰  
- èµ¤ã„ç·š = ç·šå½¢å›å¸°ç›´ç·š  
- facet ã§ç”·å¥³ã®å‚¾å‘æ¯”è¼ƒ

# Question 4

--- æœ€ã‚‚æš´åŠ›çš„ãªå›½ã¨æœ€ã‚‚å¹³å’Œçš„ãªå›½ã®æ¯”è¼ƒï¼ˆç”·æ€§å¯¿å‘½ã®åˆ†å¸ƒã‚’ç®±ã²ã’å›³ã§å¯è¦–åŒ–ï¼‰ ---

â–¼ Step 1: æš´åŠ›ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„å›½ï¼ˆ2023å¹´ï¼‰ã‚’æŠ½å‡º

```{r}
data_most_violence <- data |>
  filter(Year == 2023) |>     # 2023å¹´ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã«çµã‚‹
  slice_max(gpi, n = 20) |>   # gpi ãŒæœ€ã‚‚é«˜ã„ä¸Šä½20ã‹å›½
  mutate(label = 'Most Violent')  # ãƒ©ãƒ™ãƒ«è¿½åŠ 

# ğŸ” slice_max() ã®èª¬æ˜ï¼š
#   - æŒ‡å®šåˆ—ã®å€¤ãŒå¤§ãã„é †ã«ä¸Šã‹ã‚‰ n ä»¶ã‚’æŠ½å‡º
#   - ä¼¼ãŸé–¢æ•°ã« slice_min() ãŒã‚ã‚‹
# ä¾‹ï¼‰slice_max(gpi, n=3) ã¯ä¸Šä½3ä»¶
```

â–¼ Step 2: æš´åŠ›ãƒ¬ãƒ™ãƒ«ãŒä½ã„å›½ï¼ˆ2022å¹´ï¼‰ã‚’æŠ½å‡º

```{r}
data_most_peaceful <- data |>
  filter(Year == 2022) |>     # 2022å¹´ã«çµã‚‹
  slice_min(gpi, n = 20) |>   # gpi ãŒæœ€ã‚‚ä½ã„ä¸Šä½20ã‹å›½
  mutate(label = 'Most Peaceful')  # ãƒ©ãƒ™ãƒ«è¿½åŠ 

# ğŸ” slice_min() ã¯æœ€å°å€¤å´ã‹ã‚‰ n ä»¶
```

â–¼ Step 3: 2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã«çµåˆ

```{r}
data_plot <- rbind(data_most_violence, data_most_peaceful)
# rbind() = è¡Œæ–¹å‘ã«çµåˆ
# æ§‹é€ ä¾‹:
# | country | Year | gpi | life_exp_male | label |
```

â–¼ Step 4: ç®±ã²ã’å›³ã‚’ä½œæˆ

```{r}
plot4 <- ggplot(
  data = data_plot,                                # ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
  mapping = aes(x = label, y = life_exp_male, fill = label)  # X=ãƒ©ãƒ™ãƒ«, Y=ç”·æ€§å¯¿å‘½
) +
  geom_boxplot() +                                 # ç®±ã²ã’å›³
  coord_cartesian(ylim = c(30, 60)) +              # Yç¯„å›²
  scale_y_continuous(
    breaks = seq(10, 60, 10),
    labels = seq(10, 60, 10)
  ) +
  theme_tufte() +                                  # ãƒŸãƒ‹ãƒãƒ«ãƒ†ãƒ¼ãƒ
  scale_fill_discrete(name = '') +                 # å‡¡ä¾‹ã‚¿ã‚¤ãƒˆãƒ«éè¡¨ç¤º
  xlab('') +                                       # Xè»¸ã‚¿ã‚¤ãƒˆãƒ«ãªã—
  ylab('Life Expectancy at Age 30') +              # Yè»¸ã‚¿ã‚¤ãƒˆãƒ«
  theme(
    axis.text.y = element_text(size = 15, face = "bold"),
    legend.text = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    axis.text.x = element_text(size = 15, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold")
  )

# ãƒ—ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤º
plot4
```

å‡ºåŠ›çµæœ:  
- Xè»¸ã«ã€ŒMost Violentã€ã€ŒMost Peacefulã€  
- Yè»¸ã«ã€Œç”·æ€§ã®å¹³å‡å¯¿å‘½ï¼ˆ30æ­³æ™‚ç‚¹ï¼‰ã€  
- åˆ†å¸ƒæ¯”è¼ƒã§ã€æš´åŠ›çš„ãªå›½ã»ã©å¯¿å‘½ãŒä½ãåˆ†æ•£ãŒå¤§ãã„å‚¾å‘

# Question 5

--- æœ€ã‚‚æš´åŠ›çš„ãªå›½ã¨æœ€ã‚‚å¹³å’Œçš„ãªå›½ã®ç”·æ€§å¯¿å‘½ã®åˆ†å¸ƒã‚’å¯†åº¦ãƒ—ãƒ­ãƒƒãƒˆã§æ¯”è¼ƒ ---

â–¼ Step 1: ggplot ã®åŸºæœ¬è¨­å®š  
â–¼ Step 2: å¯†åº¦ãƒ—ãƒ­ãƒƒãƒˆã‚’ä½œæˆï¼ˆalpha ã§é€éï¼‰  
â–¼ Step 3: èƒŒæ™¯ãƒ†ãƒ¼ãƒã‚’ Stata é¢¨ã«  
â–¼ Step 4: å‡¡ä¾‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤º  
â–¼ Step 5: Xè»¸ç¯„å›²ã‚’ 30ã€œ55 ã«åˆ¶é™  
â–¼ Step 6: è»¸ãƒ©ãƒ™ãƒ«è¨­å®š  
â–¼ Step 7: ãƒ†ãƒ¼ãƒèª¿æ•´ï¼ˆæ–‡å­—ã‚µã‚¤ã‚ºãªã©ï¼‰

```{r}
plot5 <- ggplot(
  data = data_plot,                               # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆMost Violent + Most Peacefulï¼‰
  aes(x = life_exp_male, color = label, fill = label) # Xè»¸=ç”·æ€§å¯¿å‘½, è‰²ã¨å¡—ã‚Šã§ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åŒºåˆ¥
) +
  
  # â–¼ Step 2: å¯†åº¦ãƒ—ãƒ­ãƒƒãƒˆï¼ˆdensity plotï¼‰ã‚’ä½œæˆ
geom_density(alpha = 0.2, na.rm = TRUE) +
  # geom_density() = é€£ç¶šãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã‚’æ»‘ã‚‰ã‹ãªæ›²ç·šã§è¡¨ã™
  # alpha = é€éåº¦ï¼ˆ0.2ï¼‰
  # na.rm = TRUE ã§æ¬ æå€¤ã‚’ç„¡è¦–
  
  # â–¼ Step 3: èƒŒæ™¯ãƒ†ãƒ¼ãƒ
theme_stata() +
  
  # â–¼ Step 4: å‡¡ä¾‹ã®è¨­å®š
scale_fill_discrete(name = '') +
  scale_color_discrete(name = '') +
  
  # â–¼ Step 5: è»¸ã®èª¿æ•´
coord_cartesian(xlim = c(30, 55)) +
  scale_x_continuous(
    breaks = seq(30, 55, 5),
    labels = seq(30, 55, 5)
  ) +
  
  # â–¼ Step 6: è»¸ãƒ©ãƒ™ãƒ«
ylab('Density') +
  xlab('Life Expectancy') +
  
  # â–¼ Step 7: ãƒ†ãƒ¼ãƒèª¿æ•´
theme(
  axis.text.y   = element_text(size = 15, face = "bold"),
  legend.position = "bottom",
  axis.title.y  = element_text(size = 15, face = "bold"),
  axis.text.x   = element_text(size = 15, face = "bold"),
  axis.title.x  = element_text(size = 15, face = "bold")
)

# â–¼ Step 8: ãƒ—ãƒ­ãƒƒãƒˆã‚’å‡ºåŠ›
plot5
```

å‡ºåŠ›çµæœ:  
- Xè»¸ = ç”·æ€§ã®å¹³å‡å¯¿å‘½ï¼ˆ30ã€œ55ï¼‰  
- Yè»¸ = å¯†åº¦  
- è‰²ã¨å¡—ã‚Šã§ Most Violent ã¨ Most Peaceful ã‚’åŒºåˆ¥

# Question 6

--- æš´åŠ›ãƒ¬ãƒ™ãƒ«ï¼ˆGPIï¼‰ã€å¹³å‡å¯¿å‘½ã€äººå£ã€åœ°åŸŸã®é–¢ä¿‚ã‚’å¤šæ¬¡å…ƒçš„ã«å¯è¦–åŒ–ï¼ˆæ•£å¸ƒå›³ï¼‰ ---

```{r}
plot6 <- ggplot(
  data = data_scatter,                             # ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆ2023å¹´ãƒ‡ãƒ¼ã‚¿, ç”·å¥³åˆ¥ï¼‰
  mapping = aes(x = gpi, y = life_exp)             # Xè»¸ = æš´åŠ›ãƒ¬ãƒ™ãƒ«, Yè»¸ = å¹³å‡å¯¿å‘½
) +
  
  # â–¼ Step 1: æ•£å¸ƒå›³
  geom_point(aes(
    shape = area,                                  # åœ°åŸŸã§ç‚¹ã®å½¢
    color = area,                                  # åœ°åŸŸã§è‰²
    size = pop                                     # äººå£ã§ã‚µã‚¤ã‚º
  )) +
  
  # â–¼ Step 2: è»¸ãƒ©ãƒ™ãƒ«
  xlab('Level of Violence') +
  ylab('Life Expectancy at Age 30') +
  
  # â–¼ Step 3: èƒŒæ™¯ãƒ†ãƒ¼ãƒ
  theme_minimal() +
  
  # â–¼ Step 4: å›å¸°ç›´ç·š
  geom_smooth(method = "lm", se = FALSE, color = 'red') +
  
  # â–¼ Step 5: å‡¡ä¾‹ã®ã‚¿ã‚¤ãƒˆãƒ«
  labs(size = 'Population Size') +
  
  # â–¼ Step 6: å½¢ã¨è‰²
  scale_shape_manual(
    name = "Area",
    values = c(16, 17, 15, 3, 4, 8, 7, 9)
  ) +
  scale_color_brewer(
    name = "Area",
    palette = "Dark2"
  ) +
  
  # â–¼ Step 7: Yè»¸ç›®ç››ã‚Š
  scale_y_continuous(
    breaks = seq(30, 55, 5),
    labels = seq(30, 55, 5)
  ) +
  
  # â–¼ Step 8: facet
  facet_wrap(~sex) +
  
  # â–¼ Step 9: ãƒ†ã‚­ã‚¹ãƒˆèª¿æ•´
  theme(
    axis.text.y    = element_text(size = 12, face = "bold"),
    axis.title.y   = element_text(size = 15, face = "bold"),
    legend.title   = element_text(size = 15, face = "bold"),
    legend.text    = element_text(size = 15, face = "bold"),
    axis.text.x    = element_text(size = 12, face = "bold"),
    axis.title.x   = element_text(size = 15, face = "bold")
  )

# ãƒ—ãƒ­ãƒƒãƒˆã‚’å‡ºåŠ›
plot6
```

å‡ºåŠ›çµæœ:  
- Xè»¸ = GPI, Yè»¸ = Life Expectancy at Age 30  
- è‰²ã¨å½¢ = åœ°åŸŸ, ã‚µã‚¤ã‚º = äººå£  
- å›å¸°ç·šã‚ã‚Š, facet ã§ç”·å¥³åˆ¥

# Question 7

--- 2008å¹´ã‹ã‚‰2023å¹´ã®é–“ã§æš´åŠ›ãƒ¬ãƒ™ãƒ«ãŒå¢—åŠ ï¼æ¸›å°‘ã—ãŸå›½ã‚’åˆ†æãƒ»å¯è¦–åŒ– ---

â–¼ Step 1: æš´åŠ›ãŒã€Œæœ€ã‚‚å¢—åŠ ã—ãŸã€å›½ã‚’æŠ½å‡º

```{r}
data_high <- data |>
  filter(Year %in% c(2008, 2023)) |>          # 2008å¹´ã¨2023å¹´ã®ã¿
  select(Year, country, area, gpi) |>         # å¿…è¦åˆ—ã®ã¿
  pivot_wider(
    names_from = 'Year',                      # Year ã‚’åˆ—ååŒ–
    values_from = 'gpi'                       # å¹´ã”ã¨ã® GPI
  ) |>
  mutate(
    var = (`2023` - `2008`) / `2008`          # å¤‰åŒ–ç‡
  ) |>
  group_by(area) |>                           # åœ°åŸŸã”ã¨
  slice_max(var, n = 5) |>                    # å¢—åŠ ç‡ãƒˆãƒƒãƒ—5
  mutate(label = 'Highest Violence Increase') # ãƒ©ãƒ™ãƒ«
```

â–¼ Step 2: æš´åŠ›ãŒã€Œæœ€ã‚‚æ¸›å°‘ã—ãŸã€å›½ã‚’æŠ½å‡º

```{r}
data_low <- data |>
  filter(Year %in% c(2008, 2023)) |>          # åŒæ§˜
  select(Year, country, area, gpi) |>
  pivot_wider(names_from = 'Year', values_from = 'gpi') |>
  mutate(
    var = (`2023` - `2008`) / `2008`
  ) |>
  group_by(area) |>
  slice_min(var, n = 5) |>                    # æ¸›å°‘ç‡ãƒˆãƒƒãƒ—5
  mutate(label = 'Highest Violence Decrease')
```

â–¼ Step 3: 2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ

```{r}
plot_data <- rbind(data_high, data_low)
# rbind() = è¡Œæ–¹å‘ã«çµåˆ
```

â–¼ Step 4: ç‰¹å®šåœ°åŸŸï¼ˆä¾‹ï¼šåŒ—ã‚¢ãƒ•ãƒªã‚«ãƒ»è¥¿ã‚¢ã‚¸ã‚¢ï¼‰ã ã‘ã‚’æŠ½å‡ºã—å¯è¦–åŒ–

```{r}
plot7 <- plot_data |>
  filter(area == 'Northern Africa and Western Asia') |>  # åœ°åŸŸã‚’é™å®š
  ggplot(
    aes(
      x = reorder(country, var),   # å¤‰åŒ–ç‡ã§ä¸¦ã³æ›¿ãˆ
      y = var,                     # Yè»¸ = å¤‰åŒ–ç‡
      fill = label                 # å¢—åŠ  or æ¸›å°‘
    )
  ) +
  
  geom_bar(stat = 'identity') +               # æ£’ã‚°ãƒ©ãƒ•
  theme_clean() +                             # ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ãƒ¼ãƒ
  xlab('Country') +                           # Xè»¸
  ylab('Variation in Violence') +             # Yè»¸
  scale_fill_brewer(name = '', palette = 'Set2') +  # ãƒ‘ãƒ¬ãƒƒãƒˆ
  scale_y_continuous(labels = scales::percent) +    # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
  
  # â–¼ Step 5: ãƒ†ãƒ¼ãƒ
  theme(
    axis.text.x = element_text(
      angle = 45, vjust = 1, hjust = 1,
      size = 12, face = "bold"
    ),
    legend.position = 'bottom',
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 15, face = "bold"),
    axis.title.y = element_text(size = 15, face = "bold"),
    legend.text = element_text(size = 15, face = "bold")
  )

# ãƒ—ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤º
plot7
```

â–¼ Step 6: ã‚°ãƒ©ãƒ•ã‚’PDFã¨ã—ã¦ä¿å­˜

```{r}
ggsave(
  filename = "Results/plot7.pdf",  # ä¿å­˜å…ˆ
  plot = plot7,                    # å¯¾è±¡ãƒ—ãƒ­ãƒƒãƒˆ
  height = 20,                     # é«˜ã•ï¼ˆcmï¼‰
  width = 40,                      # å¹…ï¼ˆcmï¼‰
  units = "cm",                    # å˜ä½
  dpi = 400                        # è§£åƒåº¦
)
```

å‡ºåŠ›çµæœ:  
- åŒ—ã‚¢ãƒ•ãƒªã‚«ãƒ»è¥¿ã‚¢ã‚¸ã‚¢åœ°åŸŸã§ã€2008â†’2023 ã®æš´åŠ›å¢—æ¸›ãƒˆãƒƒãƒ—5ã‚’æ£’ã‚°ãƒ©ãƒ•  
- æ£’ã®é«˜ã• = å¤‰åŒ–ç‡ï¼ˆvarï¼‰  
- è‰²ã§å¢—åŠ ã¨æ¸›å°‘ã‚’åŒºåˆ¥ã€Yè»¸ã¯ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ

# Question 8

make sure to pick a reference category  
read categorical variables as factors

--- å‚ç…§ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®šã—ã€é‡ã¿ä»˜ãç·šå½¢å›å¸°ã‚’æ¨å®šã€çµæœã‚’è¡¨ã¨å›³ã§ç¢ºèªã™ã‚‹ ---

â–¼ Step 1: å› å­åŒ–ã¨å‚ç…§ã‚«ãƒ†ã‚´ãƒªã®æŒ‡å®š  
- sex ã¨ area ã‚’ factor ã«å¤‰æ›ã—å‚ç…§ã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š  
- relevel(ref = ...) ã§åŸºæº–ã‚«ãƒ†ã‚´ãƒªã‚’æŒ‡å®š  
- åŸºæº–é¸æŠã¯è§£é‡ˆã®åœŸå°

```{r}
data_scatter <- data_scatter |>
  mutate(
    sex  = relevel(as.factor(sex),  ref = "female"),              # æ€§åˆ¥ã®åŸºæº–ã‚’å¥³æ€§ã«
    area = relevel(as.factor(area), ref = "Sub-Saharan Africa")   # åœ°åŸŸã®åŸºæº–ã‚’ã‚µãƒ–ã‚µãƒãƒ©ãƒ»ã‚¢ãƒ•ãƒªã‚«ã«
  )
```

â–¼ Step 2: é‡ã¿ä»˜ãç·šå½¢å›å¸°ãƒ¢ãƒ‡ãƒ«ã®æ¨å®š  
- ç›®çš„å¤‰æ•°: life_expï¼ˆ30æ­³æ™‚ç‚¹ã®å¹³å‡ä½™å‘½ï¼‰  
- èª¬æ˜å¤‰æ•°: gpi, sex, area  
- weights = pop ã§äººå£ã‚’é‡ã¿

```{r}
model <- lm(
  life_exp ~ gpi + sex + area,
  data    = data_scatter,
  weights = pop
)

summary(model)
```

â–¼ Step 3: å›å¸°è¡¨ã‚’è¡¨ç¤º  
- moderndive::get_regression_table()

```{r}
get_regression_table(model)
```

â–¼ Step 4: å›å¸°ä¿‚æ•°ã‚’è¦–è¦šåŒ–  
- ggstats::ggcoef_model()

```{r}
ggcoef_model(model)

#-------è‡ªåˆ†ç”¨-------
plot8 <- ggcoef_model(model)

plot8

ggsave(
  filename = "Results/plot8_regression_coefficients.pdf",  # ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
  plot = plot8,      # ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã“ã“ã§æŒ‡å®šï¼ï¼‰
  height = 20,       # é«˜ã•ï¼ˆcmï¼‰
  width = 30,        # å¹…ï¼ˆcmï¼‰
  units = "cm",      # å˜ä½ã‚’cmã«è¨­å®š
  dpi = 400          # è§£åƒåº¦ï¼ˆé«˜ç”»è³ªï¼‰
)
```
